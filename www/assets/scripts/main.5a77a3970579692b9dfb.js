!function(e){function n(n){for(var r,c,i=n[0],s=n[1],l=n[2],u=0,p=[];u<i.length;u++)c=i[u],Object.prototype.hasOwnProperty.call(o,c)&&o[c]&&p.push(o[c][0]),o[c]=0;for(r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r]);for(d&&d(n);p.length;)p.shift()();return a.push.apply(a,l||[]),t()}function t(){for(var e,n=0;n<a.length;n++){for(var t=a[n],r=!0,i=1;i<t.length;i++){var s=t[i];0!==o[s]&&(r=!1)}r&&(a.splice(n--,1),e=c(c.s=t[0]))}return e}var r={},o={main:0},a=[];function c(n){if(r[n])return r[n].exports;var t=r[n]={i:n,l:!1,exports:{}};return e[n].call(t.exports,t,t.exports,c),t.l=!0,t.exports}c.m=e,c.c=r,c.d=function(e,n,t){c.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:t})},c.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},c.t=function(e,n){if(1&n&&(e=c(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var t=Object.create(null);if(c.r(t),Object.defineProperty(t,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var r in e)c.d(t,r,function(n){return e[n]}.bind(null,r));return t},c.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return c.d(n,"a",n),n},c.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},c.p="/www/";var i=window.webpackJsonp=window.webpackJsonp||[],s=i.push.bind(i);i.push=n,i=i.slice();for(var l=0;l<i.length;l++)n(i[l]);var d=s;a.push([239,"vendors~main"]),t()}({233:function(e,n){},236:function(e,n,t){"use strict";var r=t(44);t.n(r).a},239:function(e,n,t){"use strict";t.r(n);var r=t(70),o=t.n(r),a=t(69),c=t.n(a),i=t(113),s=t.n(i),l=t(68),d=t.n(l),u=t(114),p=t.n(u),f=t(115),h=t.n(f),v=t(4),m=t.n(v),g=t(14),b=t.n(g),w=t(116),y=t.n(w),x=t(45),k=t.n(x),S=t(117),C=t.n(S),_={},O=function(e){return"color: #010101; background: ".concat(e,"; padding: 2px 4px; font-size: 12px; border-radius: 4px;")};_.log=function(e,n){var t,r,o,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"log",c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#1385FF",i=(new Date).toLocaleString();"object"==C()(e)&&(n=e=""),console.log(k()(t=k()(r=k()(o="%c".concat(i," [")).call(o,a,"] - ")).call(r,e)).call(t,n?" %o":""),O(c),n||"")},_.info=function(e,n){return _.log(e,n,"info","#d35eeb")},_.debug=function(e,n){return _.log(e,n,"debug","#f3c35c")},_.err=function(e,n){return _.log(e,n,"err","#ee4949")};var I=_,P=t(118),M=t.n(P),j=Math.floor(1e8*Math.random())+1,R={data:function(){return{msg:"",peerconnections:new y.a,localStream:null,client:null,room:"123456",user:j,mySocketId:"",published:!1}},mounted:function(){return b()(m.a.mark((function e(){return m.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&I.debug("当前浏览器支持流媒体获取接口");case 1:case"end":return e.stop()}}),e)})))()},methods:{handleCreateLocalStream:function(){var e=this;return b()(m.a.mark((function n(){var t;return m.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return t={video:!0,audio:!0},n.next=3,navigator.mediaDevices.getUserMedia(t);case 3:e.localStream=n.sent,I.log("创建本地媒体流完成",{stream:e.localStream});case 5:case"end":return n.stop()}}),n)})))()},handleJoinRoom:function(){var e=this;return b()(m.a.mark((function n(){var t;return m.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(e.localStream){n.next=3;break}return n.next=3,e.handleCreateLocalStream();case 3:(t=e.client=M.a.connect()).on("connect",(function(){return I.log("成功加入信令服务")})),t.emit("join",e.room,e.user),e.handleInitSocketEvent();case 7:case"end":return n.stop()}}),n)})))()},handleLeaveRoom:function(){},handlePublish:function(){var e=this;return b()(m.a.mark((function n(){return m.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:e.published=!0;case 1:case"end":return n.stop()}}),n)})))()},handleUnpublish:function(){},handleSendMessage:function(e){this.client.emit("message",e)},handleCreatePeerConnection:function(e){var n,t=this,r=new RTCPeerConnection({iceServers:[{urls:"stun:47.94.94.203:3478"},{urls:"turn:47.94.94.203:3478",credential:"82166222",username:"maxlasting"},{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.xten.com:3478"}]});return r.onicecandidate=function(e){if(e.candidate){I.info("发送 candidate",{id:r._id});var n=t.peerconnections.get(r._id);t.handleSendMessage({peerId:r._id,from:n.own,to:n.peer,payload:{type:"candidate",index:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate}})}},r.ontrack=function(e){if(I.info("接收到远端流",{id:r._id,e:e}),!t.peerconnections.get(r._id).remoteStream){t.peerconnections.get(r._id).remoteStream=e.streams[0];var n=document.createElement("video");n.controls=!0,n.width=320,n.height=240,n.autoplay=!0,t.$refs.video.appendChild(n),n.srcObject=e.streams[0]}},h()(n=e.getTracks()).call(n,(function(n){r.addTrack(n,e)})),r},handleCreateOneByOneConnections:function(e,n){var t=this;return b()(m.a.mark((function r(){var o,a,c,i;return m.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:for(p()(n)||(n=[n]),o=0;o<n.length;o++)a=n[o],c=t.handleCreatePeerConnection(t.localStream),i=e+"-"+a,c._id=i,t.peerconnections.set(i,{own:e,peer:a,peerconnection:c,state:"waiting"});case 2:case"end":return r.stop()}}),r)})))()},handleCallOtherPeers:function(){var e=this;return b()(m.a.mark((function n(){var t,r,o,a,c,i,l,u,p;return m.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:t=!0,r=!1,o=void 0,n.prev=3,a=d()(e.peerconnections);case 5:if(t=(c=a.next()).done){n.next=15;break}return i=s()(c.value,2),l=i[0],u=i[1],n.next=9,u.peerconnection.createOffer({offerToRecieveAudio:1,offerToRecieveVideo:1});case 9:p=n.sent,u.peerconnection.setLocalDescription(p),e.handleSendMessage({to:u.peer,from:u.own,peerId:l,payload:p});case 12:t=!0,n.next=5;break;case 15:n.next=21;break;case 17:n.prev=17,n.t0=n.catch(3),r=!0,o=n.t0;case 21:n.prev=21,n.prev=22,t||null==a.return||a.return();case 24:if(n.prev=24,!r){n.next=27;break}throw o;case 27:return n.finish(24);case 28:return n.finish(21);case 29:case"end":return n.stop()}}),n,null,[[3,17,21,29],[22,,24,28]])})))()},handleAnswerOhterPeers:function(e){var n=this;return b()(m.a.mark((function t(){var r,o;return m.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return(r=n.peerconnections.get(e.peerId)).peerconnection.setRemoteDescription(new RTCSessionDescription(e.payload)),t.next=4,r.peerconnection.createAnswer();case 4:o=r.answer=t.sent,r.peerconnection.setLocalDescription(o),n.handleSendMessage({from:e.to,to:e.from,peerId:e.peerId,payload:o});case 7:case"end":return t.stop()}}),t)})))()},handleSetRemoteDsp:function(e){this.peerconnections.get(e.peerId).peerconnection.setRemoteDescription(new RTCSessionDescription(e.payload))},handleCandidate:function(e){var n=this.peerconnections.get(e.peerId),t=new RTCIceCandidate({sdpMLineIndex:e.payload.index,candidate:e.payload.candidate});n.peerconnection.addIceCandidate(t)},handleInitSocketEvent:function(){var e=this,n=this.client;n.on("joined",(function(n){var t;I.log("自己加入了",n);var r=n.socket,o=n.users;e.mySocketId=r,o.length&&(e.handleCreateOneByOneConnections(r,o),e.handleCallOtherPeers()),console.log(c()(t=e.peerconnections).call(t))})),n.on("message",(function(n){I.info("接受到 message 消息",n),n&&"offer"===n.payload.type&&(I.log("接收到远端offer",n),e.handleAnswerOhterPeers(n)),n&&"answer"===n.payload.type&&(I.log("接收到远端answer",n),e.handleSetRemoteDsp(n)),n&&"candidate"===n.payload.type&&(I.log("接收到远端 candidate",n),e.handleCandidate(n))})),n.on("peer-online",(function(n){var t;I.log("其他人加入了",n);var r=n.socket;e.handleCreateOneByOneConnections(r,e.mySocketId),console.log(c()(t=e.peerconnections).call(t))})),n.on("peer-leave",(function(e){console.log("有人离开了",e)})),n.on("hasjoin",(function(e){console.log("已经在当前房间了")})),n.on("kick",(function(){console.log("被踢出房间，其他设备登陆")})),I.log("初始化 socket 事件完成")}}},D=(t(236),t(119)),T=Object(D.a)(R,(function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("div",{staticClass:"app"},[t("div",{ref:"video",staticClass:"video-box"}),e._v(" "),t("div",{staticClass:"btns"},[t("button",{attrs:{disabled:!!e.mySocketId},on:{click:e.handleJoinRoom}},[e._v("加入房间")]),e._v(" "),t("button",{attrs:{disabled:""},on:{click:e.handleLeaveRoom}},[e._v("离开房间")]),e._v(" "),t("button",{attrs:{disabled:""},on:{click:e.handlePublish}},[e._v("开始推流")]),e._v(" "),t("button",{attrs:{disabled:""},on:{click:e.handleUnpublish}},[e._v("结束推流")])]),e._v(" "),t("div",{staticClass:"infos",domProps:{innerHTML:e._s(e.msg)}})])}),[],!1,null,null,null).exports;o.a.config.productionTip=!1,new o.a({el:"#root",render:function(e){return e(T)}})},44:function(e,n,t){}});
//# sourceMappingURL=main.5a77a3970579692b9dfb.js.map